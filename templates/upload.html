{% extends "base.html" %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
    <h2 class="text-2xl mb-6 text-center dark:text-white">Uploader une vidéo</h2>
    
    <div id="uploadForm" class="space-y-4">
        <input type="text" id="videoTitle" name="title" placeholder="Titre de la vidéo" 
               class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        
        <input type="file" id="videoFile" name="video" accept="video/*" 
               class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
        
        <button onclick="startUpload()" 
                class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 dark:bg-blue-800 dark:hover:bg-blue-700">
            Commencer l'upload
        </button>
    </div>

    <div id="uploadProgress" class="hidden mt-6">
        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4">
            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
            <span id="progressStatus">En attente...</span>
            <span id="progressPercentage">0%</span>
        </div>
        
        <div id="processingInfo" class="mt-4 text-center hidden">
            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-2 dark:text-white">Détails de traitement</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Taille du fichier</p>
                        <p id="file-size" class="font-bold dark:text-white">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Temps estimé</p>
                        <p id="estimated-time" class="font-bold dark:text-white">-</p>
                    </div>
                </div>
            </div>
            
            <div id="processingStatus" class="mt-4 flex items-center justify-center space-x-4">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-blue-600"></div>
                <p class="text-gray-600 dark:text-gray-300">Conversion en cours...</p>
            </div>
        </div>
        
        <div id="errorMessage" class="mt-4 text-center hidden">
            <div class="bg-red-100 dark:bg-red-900 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-2 text-red-700 dark:text-red-300">Erreur d'upload</h3>
                <p id="errorText" class="text-red-600 dark:text-red-400">Une erreur est survenue lors de l'upload.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    const progressPercentage = document.getElementById('progressPercentage');
    const processingInfo = document.getElementById('processingInfo');
    const processingStatus = document.getElementById('processingStatus');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const videoFile = document.getElementById('videoFile');
    const fileSizeSpan = document.getElementById('file-size');
    const estimatedTimeSpan = document.getElementById('estimated-time');

    function resetUploadState() {
        uploadForm.classList.remove('hidden');
        uploadProgress.classList.add('hidden');
        processingInfo.classList.add('hidden');
        errorMessage.classList.add('hidden');
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        progressStatus.textContent = 'En attente...';
    }

    function startUpload() {
        const file = videoFile.files[0];
        const title = document.getElementById('videoTitle').value;
        
        if (!file) {
            alert('Veuillez sélectionner un fichier');
            return;
        }

        // Vérification de la taille du fichier (limite à 1 Go)
        const MAX_FILE_SIZE = 1024 * 1024 * 1024; // 1 Go
        if (file.size > MAX_FILE_SIZE) {
            alert('Le fichier est trop volumineux. Limite : 1 Go');
            return;
        }

        const formData = new FormData();
        formData.append('video', file);
        formData.append('title', title);

        uploadForm.classList.add('hidden');
        uploadProgress.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        progressStatus.textContent = 'Préparation de l\'upload...';

        const xhr = new XMLHttpRequest();
        xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
                const percentComplete = Math.round((event.loaded / event.total) * 100);
                progressBar.style.width = `${percentComplete}%`;
                progressPercentage.textContent = `${percentComplete}%`;
                progressStatus.textContent = `Upload en cours... ${percentComplete}%`;
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                progressStatus.textContent = 'Upload terminé';
                progressPercentage.textContent = '100%';
                progressBar.style.width = '100%';
                
                try {
                    const data = JSON.parse(xhr.responseText);
                    processingInfo.classList.remove('hidden');
                    fileSizeSpan.textContent = `${data.file_size || 0} Mo`;
                    estimatedTimeSpan.textContent = data.estimated_time || '30 secondes';
                } catch (e) {
                    console.error('Erreur lors du parsing de la réponse', e);
                    errorText.textContent = 'Erreur lors du traitement de la réponse';
                    errorMessage.classList.remove('hidden');
                }
            } else {
                errorText.textContent = xhr.responseText || 'Erreur lors de l\'upload';
                errorMessage.classList.remove('hidden');
            }
        };

        xhr.onerror = () => {
            errorText.textContent = 'Erreur de réseau lors de l\'upload';
            errorMessage.classList.remove('hidden');
        };

        xhr.open('POST', '/upload', true);
        xhr.send(formData);
    }

    window.startUpload = startUpload;
});
</script>
{% endblock %}
